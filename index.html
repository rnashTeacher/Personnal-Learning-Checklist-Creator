<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Include jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Include SheetJS library for reading spreadsheet files -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Include QRCode library for generating QR codes -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>

    <title>PLC Generator</title>
    <style>
        /* Basic CSS for styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }

        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 1000px; /* Increased width to better fit table data */
            width: 90%;
        }

        .logo {
            max-width: 150px; /* Adjust the size of your logo */
            height: auto;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2em;
            color: #333;
            margin-top: 0;
        }

        p {
            color: #666;
        }

        #file-input {
            display: block;
            margin: 20px auto;
        }

        #data-display {
            margin-top: 20px;
            text-align: left;
            overflow-x: auto; /* Add horizontal scroll for wide tables */
        }

        /* Style for the generated table */
        #data-display table {
            width: 100%;
            border-collapse: collapse;
        }
        #data-display th, #data-display td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        /* Styles for row selection */
        .selection-controls {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .selection-box {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            width: 11%;
            width: 9%;
        }

        .selection-box.selection-required {
            background-color: #f8d7da; /* Light Red */
            border-color: #f5c6cb;
        }

        .selection-box.selection-complete {
            background-color: #d4edda; /* Light Green */
            border-color: #c3e6cb;
        }

        .selection-box h3 {
            margin-top: 0;
        }

        #selection-status {
            margin-top: 15px;
            font-weight: bold;
            color: #007bff;
        }

        /* Style for clickable rows */
        #data-display tr.clickable-row:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }

        /* Style for selected rows */
        #data-display tr.selected-first, #data-display tr.selected-last {
            background-color: #d1ecf1 !important; /* A light blue to indicate selection */
        }

        /* Style for the selected topic name row */
        #data-display tr.selected-topic-row {
            background-color: #d6d8db !important; /* Light gray */
        }

        /* Style for the selected resource row */
        #data-display tr.selected-resource-row {
            background-color: #e2e3e5 !important; /* Darker gray/blue */
        }

        /* Style for the selected grade column */
        #data-display .selected-grade-column {
            background-color: #cce5ff !important; /* A different blue for the entire column */
        }
        #data-display td.clickable-cell:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }
        
        /* Style for the selected topic columns */
        #data-display .selected-first-topic-column {
            background-color: #ffeeba !important; /* Light yellow for first topic column */
        }

        #data-display .selected-last-topic-column {
            background-color: #fff3cd !important; /* Slightly lighter yellow for last topic column */
        }

        /* Style for the selected max score row */
        #data-display tr.selected-max-score-row {
            background-color: #e2d9f3 !important; /* A light purple */
        }

        /* Styles for main action buttons */
        .action-buttons {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .action-buttons button {
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div class="container">
        <!-- Your Logo -->
        <img src="your-logo.png" alt="Company Logo" class="logo">

        <!-- Page Title -->
        <h1>Welcome to PLC Generator</h1>

        <!-- File Input and Data Display Area -->
        <p>Select a spreadsheet file (.xlsx, .xls, .csv) to view its contents.</p>

        <input type="file" id="file-input" accept=".xlsx, .xls, .csv" />

        <!-- Selection Controls and Display -->
        <div class="selection-controls">
            <div class="selection-box selection-required">
                <h3>Page Header</h3>
                <input type="file" id="header-image-input" accept="image/png" style="margin-top: 5px;">
                <div id="header-info">Not selected</div>
            </div>
            <div class="selection-box selection-required">
                <h3>Student Grade</h3>
                <button id="select-grade-btn">Select Column</button>
                <div id="grade-column-info">Not selected</div>
            </div>
            <div class="selection-box selection-required">
                <h3>Topic Name Row</h3>
                <button id="select-topic-row-btn">Select Row</button>
                <div id="topic-row-info">Not selected</div>
            </div>
            <div class="selection-box selection-required">
                <h3>Resource Row</h3>
                <button id="select-resource-row-btn">Select Row</button>
                <div id="resource-row-info">Not selected</div>
            </div>
            <div class="selection-box selection-required">
                <h3>First Topic</h3>
                <button id="select-topic-btn">Select Column</button>
                <div id="topic-info">Not selected</div>
            </div>
            <div class="selection-box selection-required">
                <h3>Last Topic</h3>
                <button id="select-last-topic-btn">Select Column</button>
                <div id="last-topic-info">Not selected</div>
            </div>
            <div class="selection-box selection-required">
                <h3>Max Score Row</h3>
                <button id="select-max-score-btn">Select Row</button>
                <div id="max-score-info">Not selected</div>
            </div>
            <div class="selection-box selection-required">
                <h3>First Student</h3>
                <button id="select-first-btn">Select</button>
                <div id="first-student-info">Not selected</div>
            </div>
            <div class="selection-box selection-required">
                <h3>Last Student</h3>
                <button id="select-last-btn">Select</button>
                <div id="last-student-info">Not selected</div>
            </div>
        </div>

        <div id="selection-status"></div>

        <div id="data-display"></div>

        <!-- Main Action Buttons -->
        <div class="action-buttons">
            <button id="generate-plc-btn" style="background-color: #28a745; color: white;">Generate PLC</button>
            <button id="reset-btn" style="background-color: #6c757d; color: white;">Reset Selections</button>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('file-input');
        const dataDisplay = document.getElementById('data-display');
        const selectFirstBtn = document.getElementById('select-first-btn');
        const selectLastBtn = document.getElementById('select-last-btn');
        const firstStudentInfo = document.getElementById('first-student-info');
        const lastStudentInfo = document.getElementById('last-student-info');
        const selectionStatus = document.getElementById('selection-status');
        const generatePlcBtn = document.getElementById('generate-plc-btn');
        const resetBtn = document.getElementById('reset-btn');
        const headerImageInput = document.getElementById('header-image-input');
        const headerInfo = document.getElementById('header-info');
        const selectGradeBtn = document.getElementById('select-grade-btn');
        const gradeColumnInfo = document.getElementById('grade-column-info');
        const selectTopicRowBtn = document.getElementById('select-topic-row-btn');
        const topicRowInfo = document.getElementById('topic-row-info');
        const selectResourceRowBtn = document.getElementById('select-resource-row-btn');
        const resourceRowInfo = document.getElementById('resource-row-info');
        const selectTopicBtn = document.getElementById('select-topic-btn');
        const topicInfo = document.getElementById('topic-info');
        const selectLastTopicBtn = document.getElementById('select-last-topic-btn');
        const lastTopicInfo = document.getElementById('last-topic-info');
        const selectMaxScoreBtn = document.getElementById('select-max-score-btn');
        const maxScoreInfo = document.getElementById('max-score-info');
        
        let selectionMode = null; // e.g., 'first', 'grade', 'first-topic-column', 'max-score', 'topic-row'
        let firstStudent = null; // Will store { data, index }
        let lastStudent = null; // Will store { data, index }
        let firstTopicColumnIndex = null; // Will store the index of the first topic column
        let lastTopicColumnIndex = null; // Will store the index of the last topic column
        let topicNameRowIndex = null; // Will store the index of the row containing topic names
        let resourceRowIndex = null; // Will store the index of the row containing resources
        let maxScoreRowIndex = null; // Will store the index of the row containing max scores
        let headerImageData = null; // Will store the Base64 data URL of the header image
        let gradeColumnIndex = null; // Will store the index of the grade column
        let sheetData = [];

        selectFirstBtn.addEventListener('click', () => {
            selectionMode = 'first';
            selectionStatus.textContent = 'Selection Mode: Click a row to select the First Student.';
        });

        selectLastBtn.addEventListener('click', () => {
            selectionMode = 'last';
            selectionStatus.textContent = 'Selection Mode: Click a row to select the Last Student.';
        });

        selectGradeBtn.addEventListener('click', () => {
            selectionMode = 'grade';
            selectionStatus.textContent = 'Selection Mode: Click any cell in the column containing the Student Grade.';
        });

        selectTopicRowBtn.addEventListener('click', () => {
            selectionMode = 'topic-row';
            selectionStatus.textContent = 'Selection Mode: Click the row containing the Topic Names.';
        });

        selectResourceRowBtn.addEventListener('click', () => {
            selectionMode = 'resource-row';
            selectionStatus.textContent = 'Selection Mode: Click the row containing the Resources.';
        });

        selectTopicBtn.addEventListener('click', () => {
            selectionMode = 'first-topic-column';
            selectionStatus.textContent = 'Selection Mode: Click any cell in the column containing the First Topic.';
        });

        selectLastTopicBtn.addEventListener('click', () => {
            selectionMode = 'last-topic-column';
            selectionStatus.textContent = 'Selection Mode: Click any cell in the column containing the Last Topic.';
        });

        selectMaxScoreBtn.addEventListener('click', () => {
            selectionMode = 'max-score-row';
            selectionStatus.textContent = 'Selection Mode: Click the row containing the Maximum Scores.';
        });

        headerImageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                const box = headerImageInput.closest('.selection-box');
                headerImageData = null;
                headerInfo.textContent = 'Not selected';
                box.classList.remove('selection-complete');
                box.classList.add('selection-required');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const box = headerImageInput.closest('.selection-box');
                headerImageData = e.target.result; // This is the Base64 string
                headerInfo.textContent = `Selected: ${file.name}`;
                box.classList.remove('selection-required');
                box.classList.add('selection-complete');
            };
            reader.readAsDataURL(file);
        });

        resetBtn.addEventListener('click', resetSelections);
        generatePlcBtn.addEventListener('click', generatePdf);

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            resetSelections(); // Reset if a new file is loaded

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert sheet to array of arrays to have more control
                    sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    renderTable(sheetData);

                } catch (error) {
                    console.error("Error processing the file:", error);
                    dataDisplay.innerHTML = `<p style="color: red;">Could not read the file. Please ensure it is a valid spreadsheet.</p>`;
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function renderTable(data) {
            if (!data || data.length === 0) {
                dataDisplay.innerHTML = "<p>No data to display.</p>";
                return;
            }

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            // Create header row
            const headerRow = document.createElement('tr');
            data[0].forEach((headerText, index) => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.dataset.columnIndex = index; // Store column index
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Create data rows
            for (let i = 1; i < data.length; i++) {
                const rowData = data[i];
                const tr = document.createElement('tr');
                tr.classList.add('clickable-row');
                tr.dataset.rowIndex = i; // Store original row index

                rowData.forEach(cellData => {
                    const td = document.createElement('td');
                    td.classList.add('clickable-cell');
                    td.textContent = cellData;
                    tr.appendChild(td);
                });

                tr.addEventListener('click', handleRowClick);
                tbody.appendChild(tr);
            }

            table.appendChild(thead);
            table.appendChild(tbody);
            dataDisplay.innerHTML = ''; // Clear previous content
            dataDisplay.appendChild(table);
        }

        function handleRowClick(event) {
            if (!selectionMode) return;

            if (selectionMode === 'grade') {
                const clickedCell = event.target;
                if (clickedCell.tagName !== 'TD') return; // Ensure a cell was clicked

                gradeColumnIndex = clickedCell.cellIndex;
                const headerText = sheetData[0][gradeColumnIndex] || `Column ${gradeColumnIndex + 1}`;
                gradeColumnInfo.textContent = `Selected: ${headerText}`;

                const box = selectGradeBtn.closest('.selection-box');
                box.classList.remove('selection-required');
                box.classList.add('selection-complete');

                // Clear previous column selection
                document.querySelectorAll('.selected-grade-column').forEach(el => {
                    el.classList.remove('selected-grade-column');
                });

                // Highlight the new column
                document.querySelectorAll(`#data-display tr`).forEach(row => {
                    const cell = row.children[gradeColumnIndex];
                    if (cell) {
                        cell.classList.add('selected-grade-column');
                    }
                });

            } else if (selectionMode === 'topic-row') {
                const clickedRow = event.currentTarget;
                const rowIndex = parseInt(clickedRow.dataset.rowIndex, 10);
                
                topicNameRowIndex = rowIndex;
                topicRowInfo.textContent = `Selected: Row ${rowIndex + 1}`;
                
                const box = selectTopicRowBtn.closest('.selection-box');
                box.classList.remove('selection-required');
                box.classList.add('selection-complete');

                const prevSelected = dataDisplay.querySelector('.selected-topic-row');
                if (prevSelected) {
                    prevSelected.classList.remove('selected-topic-row');
                }
                clickedRow.classList.add('selected-topic-row');
            } else if (selectionMode === 'resource-row') {
                const clickedRow = event.currentTarget;
                const rowIndex = parseInt(clickedRow.dataset.rowIndex, 10);
                
                resourceRowIndex = rowIndex;
                resourceRowInfo.textContent = `Selected: Row ${rowIndex + 1}`;
                
                const box = selectResourceRowBtn.closest('.selection-box');
                box.classList.remove('selection-required');
                box.classList.add('selection-complete');

                const prevSelected = dataDisplay.querySelector('.selected-resource-row');
                if (prevSelected) {
                    prevSelected.classList.remove('selected-resource-row');
                }
                clickedRow.classList.add('selected-resource-row');
            } else if (selectionMode === 'max-score-row') {
                const clickedRow = event.currentTarget;
                const rowIndex = parseInt(clickedRow.dataset.rowIndex, 10);
                
                maxScoreRowIndex = rowIndex;
                maxScoreInfo.textContent = `Selected: Row ${rowIndex + 1}`;
                
                const box = selectMaxScoreBtn.closest('.selection-box');
                box.classList.remove('selection-required');
                box.classList.add('selection-complete');

                const prevSelected = dataDisplay.querySelector('.selected-max-score-row');
                if (prevSelected) {
                    prevSelected.classList.remove('selected-max-score-row');
                }
                clickedRow.classList.add('selected-max-score-row');
            } else if (selectionMode === 'first' || selectionMode === 'last') {
                const clickedRow = event.currentTarget;
                const rowIndex = parseInt(clickedRow.dataset.rowIndex, 10);
                const rowData = sheetData[rowIndex];

                const prevSelected = dataDisplay.querySelector(`.selected-${selectionMode}`);
                if (prevSelected) {
                    prevSelected.classList.remove(`selected-${selectionMode}`);
                }

                if (selectionMode === 'first') {
                    firstStudent = { data: rowData, index: rowIndex };
                    firstStudentInfo.textContent = `Selected: Row ${rowIndex + 1} (${rowData[0] || ''})`;
                    clickedRow.classList.add('selected-first');
                    const box = selectFirstBtn.closest('.selection-box');
                    box.classList.remove('selection-required');
                    box.classList.add('selection-complete');
                } else if (selectionMode === 'last') {
                    lastStudent = { data: rowData, index: rowIndex };
                    lastStudentInfo.textContent = `Selected: Row ${rowIndex + 1} (${rowData[0] || ''})`;
                    clickedRow.classList.add('selected-last');
                    const box = selectLastBtn.closest('.selection-box');
                    box.classList.remove('selection-required');
                    box.classList.add('selection-complete');
                }
            } else if (selectionMode === 'first-topic-column' || selectionMode === 'last-topic-column') {
                const clickedCell = event.target;
                if (clickedCell.tagName !== 'TD') return;

                const columnIndex = clickedCell.cellIndex;
                const headerText = sheetData[0][columnIndex] || `Column ${columnIndex + 1}`;
                
                let box, prevSelectedClass, newSelectedClass;

                if (selectionMode === 'first-topic-column') {
                    firstTopicColumnIndex = columnIndex;
                    topicInfo.textContent = `Selected: ${headerText}`;
                    box = selectTopicBtn.closest('.selection-box');
                    prevSelectedClass = '.selected-first-topic-column';
                    newSelectedClass = 'selected-first-topic-column';
                } else { // last-topic-column
                    lastTopicColumnIndex = columnIndex;
                    lastTopicInfo.textContent = `Selected: ${headerText}`;
                    box = selectLastTopicBtn.closest('.selection-box');
                    prevSelectedClass = '.selected-last-topic-column';
                    newSelectedClass = 'selected-last-topic-column';
                }

                box.classList.remove('selection-required');
                box.classList.add('selection-complete');

                document.querySelectorAll(prevSelectedClass).forEach(el => {
                    el.classList.remove(newSelectedClass);
                });

                document.querySelectorAll(`#data-display tr`).forEach(row => {
                    const cell = row.children[columnIndex];
                    if (cell) {
                        cell.classList.add(newSelectedClass);
                    }
                });
            } else {
                return;
            }

            // Reset selection mode after any successful selection
            selectionMode = null;
            selectionStatus.textContent = '';
        }

        function resetSelections() {
            firstStudent = null;
            lastStudent = null;
            firstTopicColumnIndex = null;
            lastTopicColumnIndex = null;
            topicNameRowIndex = null;
            resourceRowIndex = null;
            maxScoreRowIndex = null;
            headerImageData = null;
            gradeColumnIndex = null;

            firstStudentInfo.textContent = 'Not selected';
            lastStudentInfo.textContent = 'Not selected';
            headerInfo.textContent = 'Not selected';
            gradeColumnInfo.textContent = 'Not selected';
            topicRowInfo.textContent = 'Not selected';
            resourceRowInfo.textContent = 'Not selected';
            topicInfo.textContent = 'Not selected';
            lastTopicInfo.textContent = 'Not selected';
            maxScoreInfo.textContent = 'Not selected';
            headerImageInput.value = null; // Reset the file input
            selectionStatus.textContent = '';
            selectionMode = null;

            // Reset selection box colors
            document.querySelectorAll('.selection-box').forEach(box => {
                box.classList.remove('selection-complete');
                box.classList.add('selection-required');
            });

            // Remove all selection highlight classes from the table
            const highlightedElements = dataDisplay.querySelectorAll(
                '.selected-first, .selected-last, .selected-grade-column, .selected-max-score-row, .selected-topic-row, ' +
                '.selected-first, .selected-last, .selected-grade-column, .selected-max-score-row, .selected-topic-row, .selected-resource-row, ' +
                '.selected-first-topic-column, .selected-last-topic-column'
            );
            highlightedElements.forEach(el => {
                el.classList.remove(
                    'selected-first', 'selected-last', 'selected-grade-column', 'selected-max-score-row', 'selected-topic-row',
                    'selected-first', 'selected-last', 'selected-grade-column', 'selected-max-score-row', 'selected-topic-row', 'selected-resource-row',
                    'selected-first-topic-column', 'selected-last-topic-column'
                );
            });
        }

        async function generatePdf() {
          try {
            // Run analysis first
            if (!validateAnalysisData()) {
                return;
            }

            // --- PDF Generation Logic ---

            if (!firstStudent || !lastStudent) {
                alert('Please select both a first and a last student before generating the PDF.');
                return;
            }

            if (firstTopicColumnIndex === null || lastTopicColumnIndex === null) {
                alert('Please select both the first and last topic columns before generating the PDF.');
                return;
            }

            // Ensure we have the jsPDF library loaded
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert('PDF generation library is not loaded. Please check your internet connection and try again.');
                return;
            }
            
            if (typeof QRCode === 'undefined') {
                alert('QR Code library is not loaded. Please check your internet connection and try again.');
                return;
            }

            const doc = new jsPDF();

            // Determine the start and end of the student loop, regardless of selection order
            const studentStartIndex = Math.min(firstStudent.index, lastStudent.index);
            const studentEndIndex = Math.max(firstStudent.index, lastStudent.index);

            // Determine the start and end of the topic column loop
            const topicColStartIndex = Math.min(firstTopicColumnIndex, lastTopicColumnIndex);
            const topicColEndIndex = Math.max(firstTopicColumnIndex, lastTopicColumnIndex);

            let isFirstPage = true;
            for (let i = studentStartIndex; i <= studentEndIndex; i++) {
                if (!isFirstPage) {
                    doc.addPage();
                }

                const studentData = sheetData[i];
                const studentName = studentData[0] || 'Unnamed Student'; // Assume name is in the first column

                let yPos = 20; // Starting Y position for text

                // Add the page header if it has been selected
                if (headerImageData) {
                    // Add the image. Let's make it 170mm wide and place it near the top.
                    // jsPDF uses mm as units. A4 is 210mm wide.
                    const imageWidth = 190;
                    doc.addImage(headerImageData, 'PNG', 10, 15, imageWidth, 0); // width is set, height is auto-calculated
                    yPos += 30; // Adjust starting Y position for text below the image
                }

                // Add the student name
                doc.setFontSize(18);
                doc.text(studentName, 10, yPos);
                yPos += 4; // Move down from the name

                // Add the grade if a column has been selected
                if (gradeColumnIndex !== null) {
                    const grade = studentData[gradeColumnIndex] || 'N/A';
                    yPos += 4; // Move down from the name
                    doc.setFontSize(14);
                    doc.text(`Assessment grade: ${grade}`, 10, yPos);
                    yPos += 4; // Move down for topics
                }
                
                // Analyze topics for this specific student
                const analysisResults = analyzeSingleStudent(i);

                // Add the analysis table to the PDF
                yPos += 3; // Add some space before the table
                yPos = drawAnalysisTable(doc, yPos, analysisResults);

                // Add the QR code table for very insecure topics if resources exist
                if (analysisResults.veryInsecureWithResources.length > 0) {
                    yPos += 10;
                    doc.addPage();
                    yPos = 20;
                    yPos = await drawQrCodeTable(doc, yPos, analysisResults.veryInsecureWithResources);
                }

                isFirstPage = false;
            }

            doc.save('PLC_Student_Reports.pdf');
          } catch (error) {
              console.error("PDF Generation Error:", error);
              alert("An error occurred while generating the PDF: " + error.message);
          }
        }
        
        function validateAnalysisData() {
            if (!firstStudent || !lastStudent || firstTopicColumnIndex === null || lastTopicColumnIndex === null || maxScoreRowIndex === null || topicNameRowIndex === null || resourceRowIndex === null) {
                alert('Please ensure all selection boxes (including Resource Row) are green before generating the PDF.');
                return false;
            }
            return true;
        }

        function analyzeSingleStudent(rowIndex) {
            const secureTopics = [];
            const insecureTopics = [];
            const veryInsecureTopics = [];
            const veryInsecureWithResources = [];

            const topicColStartIndex = Math.min(firstTopicColumnIndex, lastTopicColumnIndex);
            const topicColEndIndex = Math.max(firstTopicColumnIndex, lastTopicColumnIndex);
            
            const studentData = sheetData[rowIndex];

            for (let col = topicColStartIndex; col <= topicColEndIndex; col++) {
                const studentScore = parseFloat(studentData[col]);
                
                // Get max score for this specific topic column from the selected row
                const maxScoreVal = sheetData[maxScoreRowIndex][col];
                const maxScore = parseFloat(maxScoreVal);

                if (isNaN(maxScore) || maxScore === 0) continue; // Skip if max score is invalid

                const secureThreshold = maxScore * 0.66;
                const insecureThreshold = maxScore * 0.33;
                
                // Use the selected topicNameRowIndex to get the header
                let topicHeader = (sheetData[topicNameRowIndex] && sheetData[topicNameRowIndex][col]) ? sheetData[topicNameRowIndex][col] : `Topic ${col + 1}`;

                if (!isNaN(studentScore)) {
                    if (studentScore >= secureThreshold) {
                        secureTopics.push(topicHeader);
                    } else if (studentScore >= insecureThreshold) {
                        insecureTopics.push(topicHeader);
                    } else {
                        veryInsecureTopics.push(topicHeader);
                        // Get resource for this topic
                        let resourceVal = (sheetData[resourceRowIndex] && sheetData[resourceRowIndex][col]) ? sheetData[resourceRowIndex][col] : '';
                        if (resourceVal && String(resourceVal).trim() !== '') {
                            veryInsecureWithResources.push({ topic: topicHeader, resource: resourceVal });
                        }
                    }
                }
            }
            
            return { veryInsecureTopics, insecureTopics, secureTopics, veryInsecureWithResources };
        }

        function drawAnalysisTable(doc, yPos, analysisResults) {
            const { veryInsecureTopics, insecureTopics, secureTopics } = analysisResults;
            const headers = ["Very Insecure Topics", "Insecure Topics", "Secure Topics"];
            const tableData = [veryInsecureTopics, insecureTopics, secureTopics];

            const startX = 10;
            const colWidth = 63; // (210 - 2*10 margin) / 3 columns = 190 / 3 = 63.33.
            const headerHeight = 10;
            const tableTitle = "Topic Security Analysis";
            const fontSize = 8;
            const padding = 2;
            const lineHeight = 4; // Approximate line height for wrapping

            // Check if there's enough space for title and header
            if (yPos + 20 > doc.internal.pageSize.height - 10) { 
                doc.addPage();
                yPos = 15; // Reset yPos for new page
            }

            // Draw table title
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(tableTitle, startX, yPos);
            yPos += 5; // Space after title

            // Draw headers
            doc.setFontSize(fontSize); // Smaller font for table content
            doc.setFont(undefined, 'bold');
            headers.forEach((header, i) => {
                doc.rect(startX + (i * colWidth), yPos, colWidth, headerHeight);
                doc.text(header, startX + (i * colWidth) + padding, yPos + 6);
            });
            doc.setFont(undefined, 'normal');
            yPos += headerHeight;

            const maxRows = Math.max(...tableData.map(col => col.length));
            for (let i = 0; i < maxRows; i++) {
                let maxLines = 1;
                const rowContent = [];

                // Calculate height needed for this row based on wrapped text
                tableData.forEach((colData, j) => {
                    const text = String(colData[i] || '');
                    const splitText = doc.splitTextToSize(text, colWidth - (padding * 2));
                    rowContent.push(splitText);
                    if (splitText.length > maxLines) {
                        maxLines = splitText.length;
                    }
                });

                const currentRowHeight = (maxLines * lineHeight) + (padding * 2);

                // Check page break
                if (yPos + currentRowHeight > doc.internal.pageSize.height - 10) {
                    doc.addPage();
                    yPos = 15;
                }

                // Draw cells and text
                rowContent.forEach((lines, j) => {
                    doc.rect(startX + (j * colWidth), yPos, colWidth, currentRowHeight);
                    doc.text(lines, startX + (j * colWidth) + padding, yPos + padding + 3);
                });
                yPos += currentRowHeight;
            }

            return yPos; // Return the new Y position
        }

        async function drawQrCodeTable(doc, yPos, resources) {
            const headers = ["Topic", "Resource QR"];
            const startX = 10;
            const totalWidth = 190;
            const halfWidth = totalWidth / 2;
            const qrColWidth = 25;
            const topicColWidth = halfWidth - qrColWidth;
            const headerHeight = 10;
            const fontSize = 8;
            const padding = 2;
            
            // Title
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("Resources for Very Insecure Topics", startX, yPos);
            yPos += 5;

            // Headers
            doc.setFontSize(fontSize);
            doc.setFont(undefined, 'bold');
            // Left Header
            doc.rect(startX, yPos, topicColWidth, headerHeight);
            doc.text(headers[0], startX + padding, yPos + 6);
            
            doc.rect(startX + topicColWidth, yPos, qrColWidth, headerHeight);
            doc.text(headers[1], startX + topicColWidth + padding, yPos + 6);
            
            // Right Header
            doc.rect(startX + halfWidth, yPos, topicColWidth, headerHeight);
            doc.text(headers[0], startX + halfWidth + padding, yPos + 6);
            
            doc.rect(startX + halfWidth + topicColWidth, yPos, qrColWidth, headerHeight);
            doc.text(headers[1], startX + halfWidth + topicColWidth + padding, yPos + 6);

            doc.setFont(undefined, 'normal');
            yPos += headerHeight;

            for (let i = 0; i < resources.length; i += 2) {
                const item1 = resources[i];
                const item2 = resources[i+1];

                // Generate QR Code Data URL
                const qrDataUrl1 = await QRCode.toDataURL(String(item1.resource), { margin: 1 });

                // Calculate height needed for Topic text wrapping
                const splitText1 = doc.splitTextToSize(item1.topic, topicColWidth - (padding * 2));
                const textHeight1 = (splitText1.length * 4) + (padding * 2);

                let qrDataUrl2 = null;
                let splitText2 = [];
                let textHeight2 = 0;

                if (item2) {
                     qrDataUrl2 = await QRCode.toDataURL(String(item2.resource), { margin: 1 });
                     splitText2 = doc.splitTextToSize(item2.topic, topicColWidth - (padding * 2));
                     textHeight2 = (splitText2.length * 4) + (padding * 2);
                }

                const qrHeight = 25; // Fixed height for QR cell to fit 20x20 QR
                const rowHeight = Math.max(textHeight1, textHeight2, qrHeight);

                // Check page break
                if (yPos + rowHeight > doc.internal.pageSize.height - 10) {
                    doc.addPage();
                    yPos = 15;
                }

                // Draw Item 1 (Left)
                doc.rect(startX, yPos, topicColWidth, rowHeight);
                doc.text(splitText1, startX + padding, yPos + padding + 3);

                doc.rect(startX + topicColWidth, yPos, qrColWidth, rowHeight);
                const qrSize = 20;
                const qrX1 = startX + topicColWidth + (qrColWidth - qrSize) / 2;
                const qrY = yPos + (rowHeight - qrSize) / 2;
                doc.addImage(qrDataUrl1, 'PNG', qrX1, qrY, qrSize, qrSize);

                // Draw Item 2 (Right)
                const startX2 = startX + halfWidth;
                doc.rect(startX2, yPos, topicColWidth, rowHeight);
                doc.rect(startX2 + topicColWidth, yPos, qrColWidth, rowHeight);

                if (item2) {
                    doc.text(splitText2, startX2 + padding, yPos + padding + 3);
                    const qrX2 = startX2 + topicColWidth + (qrColWidth - qrSize) / 2;
                    doc.addImage(qrDataUrl2, 'PNG', qrX2, qrY, qrSize, qrSize);
                }

                yPos += rowHeight;
            }
            return yPos;
        }
    </script>
</body>
</html>
